# PHPWiki 1.3.13 - 1.4.0 Command Injection

CVE: TBC
CVSSv3: TBC
Discovered by: Ben N <pajexali@gmail.com>
Date: April 2017

## Introduction

PhpWiki is a WikiWikiWeb clone in PHP. A WikiWikiWeb is a site where
anyone can edit the pages through an HTML form. Multiple storage
backends, dynamic hyperlinking, themeable, scriptable by plugins, full
authentication, ACL's.

## Vulnerability

PHPWiki from version >= 1.3.14 and < 1.5.0 contains a command injection
vulnerability in the SyntaxHighlighter wiki plugin. Users can set the
`syntax` argument when using this plugin to have a command executed by
the web server on the operating system hosting the web application. Web
applications still using vulnerable versions of PHPWiki may allow this
vulnerablility to be realised with or without authentication.

The vulnerable code is located in the file `lib/plugin/SyntaHighlighter.php`.

Remote command injection is possible as the `syntax` argument to the
plugin implementation in a wiki page is taken without sanitisation or
validation and passed into the construction of a command string on line
139 (1). The command string is then passed to the `newFilterThroughCmd`
class method which calls the PHP builtin function `proc_open` to create
a new process using the command string (2).

```
  if (!empty($color)) $args .= " --style $color --inline-css";
             if (!empty($style)) $args .= " -F $style";
(1)             $commandLine = HIGHLIGHT_EXE . "$args -q -X -f -S $syntax";
(2)             $code = $this->newFilterThroughCmd($source, $commandLine);
             if (empty($code))
                 return $this->error(fmt("Couldn't start commandline '%s'",$commandLine));
             $pre = HTML::pre(HTML::raw($code));
             $html->pushContent($pre);
             return HTML($html);
         } else {
             return $this->error(fmt("empty source"));
```

The use of proc open in the `newFilterThroughCmd` function can be seen at (1).

```
    function newFilterThroughCmd($input, $commandLine) {
         $descriptorspec = array(
                0 => array("pipe", "r"),  // stdin is a pipe that the child will read from
                1 => array("pipe", "w"),  // stdout is a pipe that the child will write to
                2 => array("pipe", "w"),  // stdout is a pipe that the child will write to
         );
 
(1)      $process = proc_open("$commandLine", $descriptorspec, $pipes);
         if (is_resource($process)) {
```

The vulnerable code is on line 96 in `lib/plugin/SyntaxHighlighter.php`.

The issue has since been resolved starting version 1.5.0 as the code
for this plugin was refactored.
